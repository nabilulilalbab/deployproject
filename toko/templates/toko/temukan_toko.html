{% extends "base.html" %}
{% load static %}
{% block content %}
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <section class="absolute inset-0 z-0 overflow-hidden"
             x-data="{ currentSlide: 0, slides: [ '{% static 'images/bg-hero1.jpg' %}', '{% static 'images/bg-hero2.jpg' %}', '{% static 'images/bg-hero3.jpg' %}' ] }"
             x-init="setInterval(() => currentSlide = (currentSlide + 1) % slides.length, 5000)">
        <div class="absolute w-full h-full bg-cover bg-center transition-all duration-1000"
             :style="'background-image: url(' + slides[currentSlide] + ')'"></div>
        <div class="absolute inset-0 bg-black bg-opacity-30"></div>
    </section>
    <div class="relative z-10 flex flex-col items-center justify-center min-h-[calc(100vh-var(--header-height,0px)-var(--footer-height,0px))] px-4 py-8 md:pt-24 lg:pt-32 pb-12">
        <div class="flex flex-col lg:flex-row gap-6 w-full max-w-6xl mx-auto">
            <div class="w-full lg:w-2/3 bg-white shadow-xl rounded-2xl p-6 sm:p-8 text-sm animate-fadeInUp border border-blue-100">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">üîç Temukan Tempat Rental</h2>
                <form id="search-form" class="space-y-4">
                    <div>
                        <label for="searchBy" class="block font-medium text-gray-700">Cari Berdasarkan</label>
                        <select id="searchBy"
                                class="mt-1 block w-full rounded-md border border-gray-300 px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="nama">Nama Toko</option>
                            <option value="kabupaten">Kabupaten</option>
                            <option value="lokasi">Lokasi Saya</option>
                        </select>
                    </div>
                    <div id="search-input-wrapper">
                        <label for="searchInput" class="block font-medium text-gray-700">Kata Kunci</label>
                        <input type="text"
                               id="searchInput"
                               name="searchInput"
                               placeholder="Contoh: Toko Outdoor"
                               class="mt-1 block w-full rounded-md border border-blue-400 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400 outline-none" />
                    </div>
                    <div id="radius-wrapper" class="hidden">
                        <label for="radius" class="block font-medium text-gray-700">Radius (km)</label>
                        <input type="number"
                               id="radius"
                               name="radius"
                               value="25"
                               class="mt-1 block w-full rounded-md border border-gray-300 px-2 py-1 text-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 pt-2">
                        <button type="button"
                                id="btnLokasi"
                                onclick="getCurrentLocationAndSearch()"
                                class="hidden bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-md shadow text-sm font-medium flex-grow sm:flex-none">
                            üìç Cari Lokasi Saya
                        </button>
                        <button type="submit"
                                class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md shadow text-sm font-medium flex-grow sm:flex-none">
                            üîç Cari
                        </button>
                    </div>
                </form>
                <div id="map" class="w-full h-64 mt-6 rounded-md border shadow-sm"></div>
            </div>
            <div class="w-full lg:w-1/3 bg-white rounded-2xl p-6 shadow-inner border border-blue-200 self-start">
                <h3 class="text-xl font-semibold text-blue-600 mb-4">üìç Hasil Pencarian</h3>
                <ul id="hasil" class="space-y-3">
                    <li class="text-gray-500 text-sm">Silakan isi form pencarian.</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        // Set CSS custom properties for header and footer height (if applicable)
        // You might need to adjust these values based on your actual header/footer heights
        // Or, use JavaScript to dynamically get their heights if they vary.
        document.documentElement.style.setProperty('--header-height', '64px'); // Example: if your header is h-16 (64px)
        document.documentElement.style.setProperty('--footer-height', '0px'); // Adjust if your footer has a fixed height you want to subtract

        const map = L.map('map').setView([-7.05, 110.4], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let markers = [];

        function tampilkanHasil(data) {
            const hasil = document.getElementById('hasil');
            hasil.innerHTML = "";
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (!data.hasil || data.hasil.length === 0) {
                hasil.innerHTML = "<li class='text-gray-600'>Tidak ada hasil ditemukan</li>";
                return;
            }

            data.hasil.forEach(toko => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <a href="/toko/toko/${toko.id}/" class="block p-3 bg-white rounded-md border shadow-sm hover:bg-blue-50 hover:shadow-md transition">
                        <div class="font-semibold text-blue-700 text-base">${toko.nama}</div>
                        <div class="text-sm text-gray-700">${toko.alamat}</div>
                        <div class="text-sm text-gray-500">${toko.kabupaten} (${toko.jarak ?? '-'} km)</div>
                    </a>`;
                hasil.appendChild(li);

                const marker = L.marker([toko.latitude, toko.longitude])
                    .bindPopup(`<b>${toko.nama}</b><br>${toko.alamat}<br>${toko.kabupaten}`);
                marker.addTo(map);
                markers.push(marker);
            });

            // Adjust map view to fit all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.5)); // Add padding to avoid markers being on the edge
            }
        }

        document.getElementById("searchBy").addEventListener("change", function () {
            const mode = this.value;
            document.getElementById("search-input-wrapper").classList.toggle("hidden", mode === "lokasi");
            document.getElementById("radius-wrapper").classList.toggle("hidden", mode !== "lokasi");
            document.getElementById("btnLokasi").classList.toggle("hidden", mode !== "lokasi");
            // Clear input and results when changing search mode
            document.getElementById("searchInput").value = '';
            document.getElementById('hasil').innerHTML = "<li class='text-gray-500 text-sm'>Silakan isi form pencarian.</li>";
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            map.setView([-7.05, 110.4], 10); // Reset map view
        });

        document.getElementById("search-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const mode = document.getElementById("searchBy").value;
            const keyword = document.getElementById("searchInput").value.trim();

            if (mode === "lokasi") {
                getCurrentLocationAndSearch();
                return;
            }

            if (!keyword && (mode === "nama" || mode === "kabupaten")) {
                alert("Kata kunci tidak boleh kosong.");
                return;
            }

            let url = `/toko/cari/?`;
            if (mode === "nama") url += `nama=${encodeURIComponent(keyword)}`;
            if (mode === "kabupaten") url += `kabupaten=${encodeURIComponent(keyword)}`;

            fetch(url)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP error! status: ${res.status}`);
                    }
                    return res.json();
                })
                .then(data => tampilkanHasil(data))
                .catch(err => {
                    console.error("Fetch error:", err);
                    alert("Gagal memuat data: " + err.message);
                });
        });

        function getCurrentLocationAndSearch() {
            const radius = document.getElementById("radius").value;

            if (!navigator.geolocation) {
                alert("Geolocation tidak tersedia di browser Anda.");
                return;
            }

            document.getElementById('hasil').innerHTML = "<li class='text-gray-600'>Mencari lokasi Anda...</li>";

            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const url = `/toko/cari/?lat=${lat}&lon=${lon}&radius=${radius}`;

                L.marker([lat, lon]).addTo(map)
                    .bindPopup("Lokasi Anda").openPopup();
                map.setView([lat, lon], 13);

                fetch(url)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => tampilkanHasil(data))
                    .catch(err => {
                        console.error("Fetch error:", err);
                        alert("Gagal memuat lokasi: " + err.message);
                        document.getElementById('hasil').innerHTML = "<li class='text-red-600'>Gagal mendapatkan hasil pencarian.</li>";
                    });
            }, err => {
                let errorMessage;
                switch (err.code) {
                    case err.PERMISSION_DENIED:
                        errorMessage = "Izin lokasi ditolak. Harap izinkan akses lokasi di pengaturan browser Anda.";
                        break;
                    case err.POSITION_UNAVAILABLE:
                        errorMessage = "Informasi lokasi tidak tersedia.";
                        break;
                    case err.TIMEOUT:
                        errorMessage = "Waktu permintaan lokasi habis.";
                        break;
                    case err.UNKNOWN_ERROR:
                        errorMessage = "Terjadi kesalahan yang tidak diketahui saat mendapatkan lokasi.";
                        break;
                    default:
                        errorMessage = "Gagal mendapatkan lokasi: " + err.message;
                }
                alert(errorMessage);
                document.getElementById('hasil').innerHTML = "<li class='text-red-600'>" + errorMessage + "</li>";
            }, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        }
    </script>
{% endblock %}
